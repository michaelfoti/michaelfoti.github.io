<!DOCTYPE HTML>
<html>
  <head>
    <style>
      body {
        margin: 0px;
        padding: 0px;
      }
	  
	  #chatlog
	  {
		height:224px;
		overflow:auto;
      }
    </style>
  </head>
  <body>
	<center>
	<div style="width: 500px;">
		<canvas id="myCanvas" width="500" height="500" style="border:1px solid #000000;"></canvas>

		<div id="connection" class="header">
		</div>
		<input type="text" id="other_peer_id" value="PeerID to Call">
		<input type="button" value="Call" onclick="placecall()">
		<br />
		<div id="connstatus"></div>
		<div id="textBox" class="box" onKeyPress="return checkSubmit(event)">
			<p align="center">
				<textarea id="message" name="message" class="textarea" onfocus="clearContents(this);">Press enter to submit.</textarea>
			</p>
		</div>
		<div id="chatlog"></div>
		
	</div>
	</center>
	<script src="https://cdn.jsdelivr.net/npm/peerjs@1.2.0/dist/peerjs.min.js"></script>
    <script>
		function drawCircle(context, x, y, r, s, f, w){
			context.beginPath();
			context.arc(x, y, r, 0, 2 * Math.PI, false);
			context.fillStyle = f;
			context.fill();
			context.lineWidth = w;
			context.strokeStyle = s;
			context.stroke();
		}
		
		function colorLuminance(hex, lum) {
			// validate hex string
			hex = String(hex).replace(/[^0-9a-f]/gi, '');
			if (hex.length < 6) {
				hex = hex[0]+hex[0]+hex[1]+hex[1]+hex[2]+hex[2];
			}
			lum = lum || 0;
		
			// convert to decimal and change luminosity
			var rgb = "#", c, i;
			for (i = 0; i < 3; i++) {
				c = parseInt(hex.substr(i*2,2), 16);
				c = Math.round(Math.min(Math.max(0, c + (c * lum)), 255)).toString(16);
				rgb += ("00"+c).substr(c.length);
			}

			return rgb;
		}
		
		function getNewBrightnessColor(rgbcode, brightness) {
			var r = parseInt(rgbcode.slice(1, 3), 16),
			g = parseInt(rgbcode.slice(3, 5), 16),
			b = parseInt(rgbcode.slice(5, 7), 16),
			HSL = rgbToHsl(r, g, b),RGB;
		
			RGB = hslToRgb(HSL[0], HSL[1], brightness / 100);
			rgbcode = '#' +
			convertToTwoDigitHexCodeFromDecimal(RGB[0]) +
			convertToTwoDigitHexCodeFromDecimal(RGB[1]) +
			convertToTwoDigitHexCodeFromDecimal(RGB[2]);
		
			return rgbcode;
		}
		
		function convertToTwoDigitHexCodeFromDecimal(decimal) {
			var code = Math.round(decimal).toString(16);
		
			(code.length > 1) || (code = '0' + code);
			return code;
		}
		
		function rgbToHsl(r, g, b) {
			r /= 255, g /= 255, b /= 255;
			var max = Math.max(r, g, b),
				min = Math.min(r, g, b);
			var h, s, l = (max + min) / 2;
			
			if (max == min) {
				h = s = 0; // achromatic
			} else {
				var d = max - min;
				s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
				switch (max) {
				case r:
					h = (g - b) / d + (g < b ? 6 : 0);
					break;
				case g:
					h = (b - r) / d + 2;
					break;
				case b:
					h = (r - g) / d + 4;
					break;
				}
				h /= 6;
			}
			
			return [h, s, l];
		}
		
		function hslToRgb(h, s, l) {
			var r, g, b;
			
			if (s == 0) {
				r = g = b = l; // achromatic
			} else {
				function hue2rgb(p, q, t) {
				if (t < 0) t += 1;
				if (t > 1) t -= 1;
				if (t < 1 / 6) return p + (q - p) * 6 * t;
				if (t < 1 / 2) return q;
				if (t < 2 / 3) return p + (q - p) * (2 / 3 - t) * 6;
				return p;
				}
			
				var q = l < 0.5 ? l * (1 + s) : l + s - l * s;
				var p = 2 * l - q;
				r = hue2rgb(p, q, h + 1 / 3);
				g = hue2rgb(p, q, h);
				b = hue2rgb(p, q, h - 1 / 3);
			}
			
			return [r * 255, g * 255, b * 255];
		}
		
		function getMousePos(canvas, evt) {
			var rect = canvas.getBoundingClientRect();
			return {
				x: evt.clientX - rect.left,
				y: evt.clientY - rect.top
			};
		}
		
		function draw(){
			if(myBuffer.length > 0 || theirBuffer.length > 0){
				context.clearRect(0, 0, 500, 500);
				
				var i = 0;
				myBuffer.forEach(function(curCircle){
					var brightness = 100 - (i*2);
					var newColor = getNewBrightnessColor(curCircle.s, brightness);
					drawCircle(context, curCircle.x, curCircle.y, curCircle.r, newColor, newColor, curCircle.w);
					i++;
				});
				
				var i2 = 0;
				theirBuffer.forEach(function(curCircle){
					var brightness = 100 - (i2*2);
					var newColor = getNewBrightnessColor(curCircle.s, brightness);
					drawCircle(context, curCircle.x, curCircle.y, curCircle.r, newColor, newColor, curCircle.w);
					i2++;
				});
			}
		}
		
		function saveInBuffer(circleObj){
			myBuffer.push(circleObj);
			if(myBuffer.length >= 50){
				myBuffer.shift();
			}
		}
		
		function saveInTheirBuffer(circleObj){
			theirBuffer.push(circleObj);
			if(theirBuffer.length >= 50){
				theirBuffer.shift();
			}
		}
		
		function mainLoop() {
			draw();
			window.requestAnimationFrame(mainLoop);
		}

		function Circle(xpos, ypos, radius, strokeColor, fillColor, strokeWidth) {
			this.x = xpos;
			this.y = ypos;
			this.r = radius;
			this.s = strokeColor;
			this.f = fillColor;
			this.w = strokeWidth;
		}
		
		
		var placecall = function() {
			connection = peer.connect(document.getElementById('other_peer_id').value);
			connection.on('open', function(data) {
				document.getElementById('connstatus').innerHTML += "Connection Established";
			});
	
			connection.on('data', function(data) {
				//console.log(data);
				incoming = data;
				processIncoming(incoming)
				//addReceived();
			});
		};

		var sendmessage = function(message) {
			//console.log("chatmessage: " + message);
			connection.send(message);
		};
		
		var senddata = function(data) {
			connection.send(data);
		};

		function submit() {
			addSent();
			sendmessage(document.getElementById('message').value);
			document.getElementById("message").value = "";
		}

		function addSent() {
			counter++;
			var div = document.createElement('div');
			div.className = 'yourText';
			div.id = "line " + counter;
	
			document.getElementById('chatlog').appendChild(div);
			document.getElementById(div.id).innerHTML = "<span id = 'me'>You</span>: " + document.getElementById('message').value;
		}

		function addReceived() {
			counter++;
			var div = document.createElement('div');
			div.className = 'theirText';
			div.id = "line " + counter;
	
			document.getElementById('chatlog').appendChild(div);
			document.getElementById(div.id).innerHTML = "<span id = 'them'>Them</span>: " + incoming;
		}
	
		function checkSubmit(e) {
			if (e && e.keyCode == 13) {
				//console.log("yes");
				submit();
			}
		}
	
		function clearContents(element) {
			element.value = '';
		}
		
		function processIncoming(incoming){
			if(incoming.startsWith("{")){
				var incomingData = JSON.parse(incoming);
				saveInTheirBuffer(incomingData);
				return;
			}
			addReceived();
		}
	
		var init = function() {
			
			peer = new Peer(null, {
				debug: 2
            });
	
			peer.on('open', function(id) {
				document.getElementById("connection").innerHTML = "My ID is " + id;
				//console.log('My peer ID is: ' + id);
				mypeerid = id;
			});
	
			peer.on('connect', function() {
				//console.log("Connected");
				document.getElementById("connection").innerHTML = "Say something and see if anyone is listening.";
	
			});
	
			// Receive from any event
			peer.on('connection', function(conn) {
				connection = conn;
				connection.on('open', function() {
					document.getElementById('connstatus').innerHTML += "Connection Established";
				});
				connection.on('data', function(data) {
					//console.log(data);
					incoming = data;
					processIncoming(incoming)
					//addReceived();
				});
			});
		};
		
		// peer.js vars
		var counter = 0;
		var mypeerid = null;
		var peer = null;
		var connection = null;
		var incoming;
		
		// canvas vars
		var canvas = document.getElementById('myCanvas');
		var context = canvas.getContext('2d');
		var myBuffer = [];
		var theirBuffer = [];
		
		canvas.addEventListener('mousemove', function(evt) {
			var mousePos = getMousePos(canvas, evt);
			var circleObj = new Circle(mousePos.x, mousePos.y, 50, "000000", "000000", 2);
			saveInBuffer(circleObj);
			var serialised = JSON.stringify(circleObj);
			senddata(serialised);
		}, false);
	  
		window.onload = init();
		window.requestAnimationFrame(mainLoop);
		
    </script>
  </body>
</html>      